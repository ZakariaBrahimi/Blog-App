{% extends 'base.html' %}
{% block content%}
<div class="flex flex-col gap-12 my-12">
    <main id="box" class="flex flex-col gap-6 h-5/6 w-8/12 m-auto" >
        {% for post in posts %}
        <article id="{{forloop.counter}}" class="bg-white p-6 flex flex-col gap-4 shadow-lg rounded-lg post" id='postBox'>
            <img src="{{post.img.url}}" class=""  alt="">
            <h1 class="text-gray-900 text-xl">{{post.title}}</h1>
            <P class="text-gray-600">
                {{post.content|truncatewords:50}}
            </P>
            <div class="text-gray-500 flex justify-between items-center">
                <a href="{% url 'blog:singl_post' post.slug %}">
                    <button class="border-2 p-2 px-5 rounded border-gray-500 hover:bg-gray-500 hover:text-white  transition duration-500 ease-in-out">Continue Reading</button>
                </a>
                <div class="">
                    <span class="border-r-2 px-4">{{post.published_at|date:"D, d M, Y"}}</span>
                        
                            <form action="" method='POST' id='likeForm' class="{{post.id}}">
                                {% csrf_token %}
                                <span class="border-r-2 px-4" >
                                    <button type="submit" id="likeBtn" name='post_id' value="{{post.id}}">
                                        <svg id="likeBtn" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                    <span id="totalLikes">{{post.totalLikes}}</span>
                                
                                </span>
                            </form>
                    


                    <span class=" px-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd" />
                        </svg>
                        
                        {{post.comment_set.all|length}}
                    </span>
                </div>
            </div>
        </article>
        {% endfor %}

        

        
    </main>
    <div class='flex flex-col items-center justify-center gap-4'>
        <button class="bg-blue-500 p-2 px-4 rounded-lg shadow-lg flex text-white font-bold" type="button" id='loadMoreBtn'>More Posts</button>            
    </div>
    {% if  user.is_authenticated %}
    <aside class=" flex flex-col items-center p-6 bg-white h-full w-3/12 rounded-lg mr-6 shadow-lg ">
        <a href=" {% url 'blog:create_post' %} ">
            <button id="createPostBtn" class="bg-blue-500 p-2 px-24 shadow-2xl rounded-lg text-white hover:shadow-4xl font-bold" type="submit">New Post</button>
            
        </a>
    </aside>
    {% endif%}
</div>
{%endblock%}
{%block bottom_js%}

<script>
const convertToMonth = (month)=>{
  switch (month){
    case "01":
      return 'Jan';
      break;
    case "02":
      return 'Feb';
      break;
    case "09":
      return 'Sept';
      break;
      case "10":
      return 'Oct';
      break;
  }
}
const displayTime = (time)=>{
    // "23T06:41:38.018Z"
    let hour = time.slice(3,5);
    let minute = time.slice(6,8);
    let t = 'p.m';
    if(hour[0] === "0"){
      t = 'a.m'
      // hour = hour[1];
    }
    let result = `${hour}:${minute} ${t}.`;
    return result // 6:40 a.m.
  
  }
let displayDate = (date)=>{
  // Sept. 23, 2021, 6:40 a.m.
  // date = fields['published_at'] ===>> 2021-09-23T06:41:38.018Z
  let dateArray = date.split("-"); // [ "2021", "09", "23T06:41:38.018Z" ]
  let year = dateArray[0];
  let month = convertToMonth(dateArray[1]);
  let day = dateArray[2].slice(0,2);
  let time = displayTime(dateArray[2]);
  let result = `${month}. ${day}, ${year}, ${time}`;
  return result
}
//======================================================= Load More Btn ===================================================

const postBox = document.querySelector('#postBox');
const continair = document.querySelector('#box')
const loadMoreBtn = document.querySelector('#loadMoreBtn');
//let lastChild = continair.lastElementChild.getAttribute('id');
let visible = 4
const handlgetData = ()=> {
    fetch("/posts/"+ visible,
  {
    headers: {
        "X-Requested-With": "XMLHttpRequest", //Necessary to work with request.is_ajax()
    },
  }
    ).then(function(response) {
      return response.json(); //Convert response to JSON Data
    }).then(function(response){
      const data = response.data // ===>> string
      let instance = JSON.parse(response["data"]); // ===>> object
      //console.log(instance)
      instance.map(post => {
        let date = displayDate(post['fields']['published_at'])
        continair.innerHTML += `
      <article class="bg-white p-6 flex flex-col gap-4 shadow-lg rounded-lg post" id='postBox'>
        <img src="/media/${post['fields']['img']}"  alt="">
        <h1 class="text-gray-900 text-xl">${post['fields']['title']}</h1>
        <P class="text-gray-600">
            ${post['fields']['content']}
            post.content|truncatewords:50
        </P>
        <div class="text-gray-500 flex justify-between items-center">
            <a href="/singl-post/${post['fields']['slug']}/">
                <button class="border-2 p-2 px-5 rounded border-gray-500 hover:bg-gray-500 hover:text-white  transition duration-500 ease-in-out">Continue Reading</button>
            </a>
            <div class="">
                <span class="border-r-2 px-4">
                    ${date}
                

                <form id="" action="" method='POST' class='likeForm'>
                    {% csrf_token %}
                    
                    <span class="border-r-2 px-4" >
                        <button type="submit">
                            <svg id="likeBtn" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        {{post.like_set.all|length}}
                    </span>
                </form>
                


                <span class=" px-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd" />
                    </svg>
                    {{post.comment_set.all|length}}
                </span>
            </div>
        </div>
    </article>
      `

    })
})}
//handlgetData();
loadMoreBtn.addEventListener('click', (e)=>{
    e.preventDefault();    
    visible += 3
    handlgetData();
    console.log('clicked')
});

// ===============================Like Ajax request handling ========================================
/*
url = 'localhost/likes/postID'
1. Create likeView(request)
    a. return an json response contains the followins json data {total likes}
2. Request data from the above url 
    a. fetching data on javascript and then display it on HTML

*/

const likeBtn = document.getElementById('likeBtn')

const likeForm = document.getElementById('likeForm')
const totalLikes = document.getElementById('totalLikes')
//let hiddenInput = document.getElementById('hiddenInput')
likeForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    let csrfValue = document.getElementsByName("csrfmiddlewaretoken")[0].value;
    let postID = likeBtn.getAttribute('value')
    print(postID)
    console.log('submited')
      fetch(`totalLikes/${postID}/`, {
        method: "Post",
        headers: {
          "X-CSRFToken": csrfValue,
          "X-Requested-With": "XMLHttpRequest" //Necessary to work with request.is_ajax()
        },
      }).then(function(response) {
        return response.json();
      }).then(function(response) {        
        let instance = JSON.parse(response["data"]);
        console.log(instance)
        totalLikes.innerHTML = instance
      }).catch((error) => {
        console.error("Error", error);
      })
})

</script>
{%endblock%}